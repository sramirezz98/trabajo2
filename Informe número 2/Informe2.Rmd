---
editor_options:
  markdown:
    wrap: 72
---

::: {.text-justify}
---
title: "SEGMENTACIÓN DE CLIENTES CORPORATIVOS DE UNA EMPRESA"
author:
- Carlos Mario Calle González
- Catherine Andrea Córdoba Espinosa
- Allison Piedrahita García
- Santiago Ramírez Zapata
- Jhonier Santiago Serna Cardona
date: "11/05/2021"
output:
  html_document:
    theme: united
    highlight: tango
  pdf_document: default
---

```{r setup, include=FALSE, message=FALSE, warning=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(ggcorrplot)
library(GGally)
library(plotly)
library(readr)
library(patchwork)
library(fmsb)
library(knitr)
library(DT)
library(cluster)
library(formattable)
library(tidyr)
library("dendextend")
```

**Objetivo**: Realizar la segmentación de clientes para una empresa
cuyos clientes son otras empresas. Explorar las relaciones entre las
variables y una posible agrupación de las mismas según sus
características.

### Introducción

Las técnicas de segmentación son una herramienta importante a la hora de
trabajar con volúmenes considerables de información referente a
diferentes tipos de clientes que hacen parte de un mercado. Esto se debe
a que no todos son iguales ni tienen las mismas necesidades, razón por
la cual es fundamental conocer las características relevantes de cada
uno para agrupar perfiles afines, con el fin de lograr una mejor
atención, fidelización de los clientes, tomar decisiones estratégicas y
de marketing, ahorrar tiempo y mejorar el rendimiento, entre muchos
otros beneficios.

### Contextualización

**Materiales**: Se analizó una base de datos con $2233$ usuarios y $46$
variables en total, las cuales se dividen en 2 grupos principales:

-   **Variables de comportamiento de los clientes en canales y
    productos**: Consta de $30$ variables, divididas en *entradas* y
    *salidas* según la siguiente nomenclatura:

    -   $en$: Entrada
    -   $sal$: Salida
    -   $vm$: Valor medio anual
    -   $tx$: Transacciones mensuales promedio

    A continuación se ilustran algunos ejemplos teniendo en cuenta lo
    mencionado:

    -   **en_vm_canalX**: valor del ticket promedio de entrada por el
        canal X
    -   **en_tx_canalX**: cantidad de transacciones mensuales de entrada
        en promedio por el canal X
    -   **sal_vm_canalX**: valor del ticket promedio de salida por el
        canal X
    -   **sal_tx_canalX**: cantidad de transacciones mensuales de salida
        en promedio por el canal X

    **Notas**:

    -   Se entiende por "valor del ticket" al valor de una transacción
        ya sea de entrada o salida.
    -   Entre las transacciones de entrada se pueden encontrar las
        devoluciones, los recaudos, las consignaciones, entre otros.
    -   Entre las transacciones de salida se pueden encontrar las
        compras, los pagos, entre otros.
    -   Por canal X se entiende a los medios físicos o virtuales por los
        cuales se realizan las transacciones de entrada o salida. Entre
        algunos ejemplos se pueden encontrar las sucursales físicas y
        las sucursales virtuales.

-   **Variables de estados financieros y características de los
    clientes**: Consta de $16$ variables, algunas categorizadas. Estas
    variables categorizadas son categóricas ordinales:

    -   **impo_cv**: [importaciones]/[compras]
    -   **expo_vt**: [exportaciones]/[ventas]
    -   **cxp**: [cuentas por pagar] categorizada con seis niveles
    -   **cxc**: [cuentas por cobrar] categorizada con seis niveles
    -   **totalinventory**: [valor de inventarios] categorizada con seis
        niveles
    -   **pagos_pj**: [pagos hechos a personas jurídicas]/[pagos
        totales]
    -   **pagos_pn**: [pagos hechos a personas naturales]/[pagos
        totales]
    -   **tiene_ventas_fisicas**: la empresa tiene puntos de venta
        físicos (1:Si, 0:No)
    -   **tiene_ventas_electronicas**: la empresa tiene ventas
        electrónicas (1:Si, 0:No)
    -   **recaudos_pj**: [recaudos provenientes de personas
        jurídicas]/[recaudos totales]
    -   **recaudos_pn**: [recaudos provenientes de personas
        naturales]/[recaudos totales]
    -   **rotacion_inventarios**: [rotación de inventarios en días]
        categorizada con seis niveles
    -   **rotacion_cxc**: [rotación de cuentas por pagar en días]
        categorizada con seis niveles
    -   **rotacion_cxp**: [rotación de cuentas por cobrar en días]
        categorizada con seis niveles
    -   **ciclo_negocio**: [ciclo de negocio en días] categorizada con
        seis niveles
    -   **ciclo_financiero**: [ciclo financiero en días] categorizada
        con seis niveles

```{r echo=FALSE}
datos_completos <- read.csv("base_trabajo_segmentacion.csv", header = TRUE, sep = ";")
```

```{r message=FALSE, warning=FALSE}
datos_completos <- select(datos_completos, -c(recaudos_pj, recaudos_pn))
attach(datos_completos)
```

### Análisis descriptivo

se obtienen las medidas de tendencia central y de dispersión de las
variables mencionadas y las correlaciones por pares.

#### **Variables de comportamiento de los clientes en canales y productos:**

```{r echo=FALSE}
mediasx <- apply(datos_completos[,-c(1,32:47)],2,mean,na.rm=FALSE)
minimosx <- apply(datos_completos[,-c(1,32:47)],2,min,na.rm=FALSE)
maximosx <- apply(datos_completos[,-c(1,32:47)],2,max,na.rm=FALSE)
desviacionx <- apply(datos_completos[,-c(1,32:47)],2,sd,na.rm=FALSE)
medianax <- apply(datos_completos[,-c(1,32:47)],2,median,na.rm=FALSE)
qu1x <- apply(datos_completos[,-c(1,32:47)],2,quantile,0.25, na.rm=FALSE)
qu3x <- apply(datos_completos[,-c(1,32:47)],2,quantile,0.75, na.rm=FALSE)
x <- data.frame(mediasx, minimosx, maximosx, desviacionx, medianax, qu1x, qu3x)

datatable(x, colnames=c("Media", "Mínimo", "Máximo", "Desviación estándar", "Mediana", "Cuartil 1", "Cuartil 3"), caption = "MEDIDAS DE TENDENCIA CENTRAL PARA VARIABLES DE COMPORTAMIENTO DE LOS CLIENTES EN CANALES Y PRODUCTOS", class = "cell-border")
```

##### **Diagrama de correlación de las variables de comportamiento de los clientes en canales y productos**

```{r echo=FALSE}
# Cálculo de la matriz de correlaciones
cor_mat <- cor(datos_completos[,-c(1,32:47)],use = "na.or.complete")
# Visualización de la matriz de correlaciones:
ggcorrplot(cor_mat,method = "square", lab=TRUE, lab_size = 1.4, tl.cex = 8, colors = c("#6D9EC1", "white", "#E46726"))
```

#### **Variables de estados financieros y características de los clientes:**

```{r echo=FALSE}
contar <- function(x, k){
  n=0
  for (i in 1:length(x)){
    if (x[i]==k){
      n=n+1
    }
  }
  return (n)
}
y <- datos_completos[,-c(1:31, 37, 38, 41, 42, 39, 40)]
unos <- apply(y,2,contar, k=1)
dos <- apply(y,2,contar, k=2)
tres <- apply(y,2,contar, k=3)
cuatro <- apply(y,2,contar, k=4)
cinco <- apply(y,2,contar, k=5)
seis <- apply(y,2,contar, k=6)

y1 <- data.frame(unos, dos, tres, cuatro, cinco, seis)
datatable(y1, colnames=c("Categoría 1", "Categoría 2", "Categoría 3", "Categoria 4", "Categoria 5", "Categoria 6"),caption = "FRECUENCIAS DE LAS VARIABLES DE ESTADOS FINANCIEROS Y CARACTERÍSTICAS DE LOS CLIENTES, CATEGORIZADAS", class = "cell-border")

datatable(table(datos_completos$tiene_ventas_fisicas, datos_completos$tiene_ventas_electronicas), rownames= FALSE, colnames = c("Tiendas físicas", "Tiendas electrónicas", "Frecuencias"), class="cell-border", caption = "¿EL CLIENTE CUENTA CON TIENDA FÍSICA Y/O ELECTRÓNICA [1: Sí, 0: No]?")

mediasw <- apply(datos_completos[,c(37, 38, 41, 42)],2,mean,na.rm=FALSE)
minimosw <- apply(datos_completos[,c(37, 38, 41, 42)],2,min,na.rm=FALSE)
maximosw <- apply(datos_completos[,c(37, 38, 41, 42)],2,max,na.rm=FALSE)
desviacionw <- apply(datos_completos[,c(37, 38, 41, 42)],2,sd,na.rm=FALSE)
medianaw <- apply(datos_completos[,c(37, 38, 41, 42)],2,median,na.rm=FALSE)
qu1w <- apply(datos_completos[,c(37, 38, 41, 42)],2,quantile,0.25, na.rm=FALSE)
qu3w <- apply(datos_completos[,c(37, 38, 41, 42)],2,quantile,0.75, na.rm=FALSE)
w <- data.frame(mediasw, minimosw, maximosw, desviacionw, medianaw, qu1w, qu3w)

datatable(w, colnames=c("Media", "Mínimo", "Máximo", "Desviación estándar", "Mediana", "Cuartil 1", "Cuartil 3"),caption = "MEDIDAS DE TENDENCIA CENTRAL PARA LOS PAGOS Y RECAUDOS PROVENIENTES DE PERSONAS JURÍDICAS O NATURALES", class = "cell-border")
```

##### **Diagrama de correlación de las variables de estados financieros y características de los clientes**

```{r echo=FALSE}
# Cálculo de la matriz de correlaciones
cor_mat1 <- cor(datos_completos[,-c(1:31)],use = "na.or.complete")
# Visualización de la matriz de correlaciones:
ggcorrplot(cor_mat1,method = "square", lab=TRUE, lab_size = 2.2, tl.cex = 8, colors = c("#6D9EC1", "white", "#E46726"))
```

### Desarrollo estadístico
#### Selección y procesamiento de variables
En primer lugar, se eliminarón las variables `recaudos_pn` y
`recaudos_pj`, porque no contenían información relevante, pues eran una
constante igual a $0$. Por el lado de las variables de estados
financieros, se eliminan las variables `rotacion_inventarios`,
`rotacion_cxc` y `rotacion_cxp`, puesto que desde el punto de vista
contable estas se pueden resumir en las variables `ciclo_negocio` y
`ciclo_financiero`. Adicionalmente, se realiza una estandarización a las variables cuantitativas denominadas como $Variables~~de~~comportamiento~~de~~los~~clientes~~en~~canales~~y~~productos$, para cada una de las observaciones de estas variables se asigna uno de los cuartiles dependiendo el valor que dicha observación tenga. Lo anterior, se hace con el fin de obtener una mejor segmentación de los datos más adelante. Con esta estandarización, el conjunto de variables queda compuesto por variables categóricas ordinales y binarias. 

```{r}
library(gtools)
datos_cluster <- select(datos_completos, -c(nit,rotacion_inventarios, rotacion_cxc, rotacion_cxp))

datos_cluster$en_vm_canal1 <- quantcut(datos_cluster$en_vm_canal1,q = 4,labels = c("1","2","3","4"))
datos_cluster$en_vm_canal2 <- quantcut(datos_cluster$en_vm_canal2,q = 4,labels = c("1","2","3","4"))
datos_cluster$en_vm_canal3 <- quantcut(datos_cluster$en_vm_canal3,q = 4)
levels(datos_cluster$en_vm_canal3) <- c("1", "2", "3","4")

datos_cluster$en_vm_canal4 <- quantcut(datos_cluster$en_vm_canal4,q = 4)
levels(datos_cluster$en_vm_canal4) <- c("1", "2", "3","4")
datos_cluster$en_vm_canal5 <- quantcut(datos_cluster$en_vm_canal5,q = 4)
levels(datos_cluster$en_vm_canal5) <- c("1", "2", "3","4")
datos_cluster$en_vm_canal6 <- quantcut(datos_cluster$en_vm_canal6,q = 4,labels = c("1","2","3","4"))
datos_cluster$en_vm_canal7 <- quantcut(datos_cluster$en_vm_canal7,q = 4)
levels(datos_cluster$en_vm_canal7) <- c("1", "2", "3","4")
datos_cluster$en_vm_canal8 <- quantcut(datos_cluster$en_vm_canal8,q = 4)
levels(datos_cluster$en_vm_canal8) <- c("1", "2", "3","4")
datos_cluster$en_vm_canal9 <- quantcut(datos_cluster$en_vm_canal9,q = 4)
levels(datos_cluster$en_vm_canal9) <- c("1", "2", "3","4")
datos_cluster$en_vm_canal10 <- quantcut(datos_cluster$en_vm_canal10,q = 4)
levels(datos_cluster$en_vm_canal10) <- c("1", "2", "3","4")
datos_cluster$en_vm_otros <- quantcut(datos_cluster$en_vm_otros,q = 4)
levels(datos_cluster$en_vm_otros) <- c("1", "2", "3","4")

datos_cluster$en_tx_canal1 <- quantcut(datos_cluster$en_tx_canal1,q = 4,labels = c("1","2","3","4"))
datos_cluster$en_tx_canal2 <- quantcut(datos_cluster$en_tx_canal2,q = 4,labels = c("1","2","3","4"))
datos_cluster$en_tx_canal3 <- quantcut(datos_cluster$en_tx_canal3,q = 4)
levels(datos_cluster$en_tx_canal3) <- c("1", "2", "3","4")
datos_cluster$en_tx_canal4 <- quantcut(datos_cluster$en_tx_canal4,q = 4)
levels(datos_cluster$en_tx_canal4) <- c("1", "2", "3","4")
datos_cluster$en_tx_canal5 <- quantcut(datos_cluster$en_tx_canal5,q = 4)
levels(datos_cluster$en_tx_canal5) <- c("1", "2", "3","4")
datos_cluster$en_tx_canal6 <- quantcut(datos_cluster$en_tx_canal6,q = 4,labels = c("1","2","3","4"))
datos_cluster$en_tx_canal7 <- quantcut(datos_cluster$en_tx_canal7,q = 4)
levels(datos_cluster$en_tx_canal7) <- c("1", "2", "3","4")
datos_cluster$en_tx_canal8 <- quantcut(datos_cluster$en_tx_canal8,q = 4)
levels(datos_cluster$en_tx_canal8) <- c("1", "2", "3","4")
datos_cluster$en_tx_canal9 <- quantcut(datos_cluster$en_tx_canal9,q = 4)
levels(datos_cluster$en_tx_canal9) <- c("1", "2", "3","4")
datos_cluster$en_tx_canal10 <- quantcut(datos_cluster$en_tx_canal10,q = 4)
levels(datos_cluster$en_tx_canal10) <- c("1", "2", "3","4")
datos_cluster$en_tx_otros <- quantcut(datos_cluster$en_tx_otros,q = 4)
levels(datos_cluster$en_tx_otros) <- c("1", "2", "3","4")

datos_cluster$sal_vm_canal2 <- quantcut(datos_cluster$sal_vm_canal2,q = 4,labels = c("1","2","3","4"))
datos_cluster$sal_vm_canal5 <- quantcut(datos_cluster$sal_vm_canal5,q = 4)
levels(datos_cluster$sal_vm_canal5) <- c("1", "2", "3","4")
datos_cluster$sal_vm_canal8 <- quantcut(datos_cluster$sal_vm_canal8,q = 4)
levels(datos_cluster$sal_vm_canal8) <- c("1", "2", "3","4")
datos_cluster$sal_vm_otros <- quantcut(datos_cluster$sal_vm_otros,q = 4)
levels(datos_cluster$sal_vm_otros) <- c("1", "2", "3","4")

datos_cluster$sal_tx_canal2 <- quantcut(datos_cluster$sal_tx_canal2,q = 4,labels = c("1","2","3","4"))
datos_cluster$sal_tx_canal5 <- quantcut(datos_cluster$sal_tx_canal5,q = 4)
levels(datos_cluster$sal_tx_canal5) <- c("1", "2", "3","4")
datos_cluster$sal_tx_canal8 <- quantcut(datos_cluster$sal_tx_canal8,q = 4)
levels(datos_cluster$sal_tx_canal8) <- c("1", "2", "3","4")
datos_cluster$sal_tx_otros <- quantcut(datos_cluster$sal_tx_otros,q = 4)
levels(datos_cluster$sal_tx_otros) <- c("1", "2", "3","4")

datos_cluster$pagos_pj <- quantcut(datos_cluster$pagos_pj,q = 4,labels = c("1","2","3","4"))
datos_cluster$pagos_pn <- quantcut(datos_cluster$pagos_pn,q = 4,labels = c("1","2","3","4"))

datos_cluster$en_vm_canal1 <- ordered(datos_cluster$en_vm_canal1,levels=1:4)
datos_cluster$en_vm_canal2 <- ordered(datos_cluster$en_vm_canal2,levels=1:4)
datos_cluster$en_vm_canal3 <- ordered(datos_cluster$en_vm_canal3,levels=1:4)
datos_cluster$en_vm_canal4 <- ordered(datos_cluster$en_vm_canal4,levels=1:4)
datos_cluster$en_vm_canal5 <- ordered(datos_cluster$en_vm_canal5,levels=1:4)
datos_cluster$en_vm_canal6 <- ordered(datos_cluster$en_vm_canal6,levels=1:4)
datos_cluster$en_vm_canal7 <- ordered(datos_cluster$en_vm_canal7,levels=1:4)
datos_cluster$en_vm_canal8 <- ordered(datos_cluster$en_vm_canal8,levels=1:4)
datos_cluster$en_vm_canal9 <- ordered(datos_cluster$en_vm_canal9,levels=1:4)
datos_cluster$en_vm_canal10 <- ordered(datos_cluster$en_vm_canal10,levels=1:4)
datos_cluster$en_vm_otros <- ordered(datos_cluster$en_vm_otros,levels=1:4)

datos_cluster$en_tx_canal1 <- ordered(datos_cluster$en_tx_canal1,levels=1:4)
datos_cluster$en_tx_canal2 <- ordered(datos_cluster$en_tx_canal2,levels=1:4)
datos_cluster$en_tx_canal3 <- ordered(datos_cluster$en_tx_canal3,levels=1:4)
datos_cluster$en_tx_canal4 <- ordered(datos_cluster$en_tx_canal4,levels=1:4)
datos_cluster$en_tx_canal5 <- ordered(datos_cluster$en_tx_canal5,levels=1:4)
datos_cluster$en_tx_canal6 <- ordered(datos_cluster$en_tx_canal6,levels=1:4)
datos_cluster$en_tx_canal7 <- ordered(datos_cluster$en_tx_canal7,levels=1:4)
datos_cluster$en_tx_canal8 <- ordered(datos_cluster$en_tx_canal8,levels=1:4)
datos_cluster$en_tx_canal9 <- ordered(datos_cluster$en_tx_canal9,levels=1:4)
datos_cluster$en_tx_canal10 <- ordered(datos_cluster$en_tx_canal10,levels=1:4)
datos_cluster$en_tx_otros <- ordered(datos_cluster$en_tx_otros,levels=1:4)

datos_cluster$sal_vm_canal2 <- ordered(datos_cluster$sal_vm_canal2,levels=1:4)
datos_cluster$sal_vm_canal5 <- ordered(datos_cluster$sal_vm_canal5,levels=1:4)
datos_cluster$sal_vm_canal8 <- ordered(datos_cluster$sal_vm_canal8,levels=1:4)
datos_cluster$sal_vm_otros <- ordered(datos_cluster$sal_vm_otros,levels=1:4)

datos_cluster$sal_tx_canal2 <- ordered(datos_cluster$sal_tx_canal2,levels=1:4)
datos_cluster$sal_tx_canal5 <- ordered(datos_cluster$sal_tx_canal5,levels=1:4)
datos_cluster$sal_tx_canal8 <- ordered(datos_cluster$sal_tx_canal8,levels=1:4)
datos_cluster$sal_tx_otros <- ordered(datos_cluster$sal_tx_otros,levels=1:4)

datos_cluster$pagos_pj <- ordered(datos_cluster$pagos_pj,levels=1:4)
datos_cluster$pagos_pn <- ordered(datos_cluster$pagos_pn,levels=1:4)

datos_cluster$impo_cv <- ordered(datos_cluster$impo_cv,levels=1:5)
datos_cluster$expo_vt <- ordered(datos_cluster$expo_vt,levels=1:3)
datos_cluster$cxp <- ordered(datos_cluster$cxp,levels=1:6)
datos_cluster$cxc <- ordered(datos_cluster$cxc,levels=1:6)
datos_cluster$totalinventory <- ordered(datos_cluster$totalinventory,levels=1:6)
datos_cluster$tiene_ventas_fisicas <- as.factor(datos_cluster$tiene_ventas_fisicas)
datos_cluster$tiene_ventas_electronicas <- as.factor(datos_cluster$tiene_ventas_electronicas)
datos_cluster$ciclo_negocio <- ordered(datos_cluster$ciclo_negocio,levels=1:6)
datos_cluster$ciclo_financiero <- ordered(datos_cluster$ciclo_financiero,levels=1:6)
```

#### Agrupación
Una vez se ha procesado la base de datos con que se trabajará y se ha
establecido la forma de los datos, se procede con el análisis para
segmentar a los clientes corporativos. Para cumplir con lo anterior, en
primer lugar se debe tener alguna medida de similitudes o disimilitudes
entre las variables, por ello se calcula la distancia de Gower (1971),
pues esta permite trabajar tanto con variables númericas como
categóricas. Una forma sencilla de ver esta distancia es que para cada
uno de los tipos de variables se usa una medida de distancia particular
que funcione para ese tipo y se escala dicha distancia entre 0 y 1.
Posteriormente, se calcula la combinación lineal especificando los pesos
de cada uno de los componentes de la combinación lineal (una forma
sencilla es usar el promedio), finalmente con esto se crea la matriz de
distancias.

Las medidas que se usan para cada tipo de variable se describen a
continuación:

-   Cuantitativa: se calcula la distancia de Manhattan normalizada por
    rangos.

-   Ordinal: en primer lugar, se clasifica la variable, luego se calcula
    la distancia Manhattan, con un ajuste especial para los empates.

-   Nominal: las k categorías de la variable se convierte en k columnas
    binarias y posteriormente se usa el coeficiente de Dice.

Este método es sensible a la no normalidad y a datos atípicos, por lo
que la transformación de las variables son un paso necesario como parte
del preprocesamiento de datos [1].

```{r}
dist_gower <- daisy(datos_cluster,metric = "gower")
d <- summary(dist_gower)
d <- d$summ
d <- t(d)[,c(1:6)]
kable(d, col.names ="Valor", align = 'c', caption = "Medidas de tendencia para la distancia de Gower")
```

Haciendo agrupamiento jerarquico/aglomerativo, utilizando el método $complete$ para medir distancias entre grupos, se obtiene lo siguiente:

```{r}
cluster_jerar <- hclust(dist_gower,method = "complete")
plot(cluster_jerar, main = "Dendograma", ylab = "Altura", xlab = "Distancia de Gower - Método 'Complete'")
```

De acuerdo al gráfico, se identifican varios cortes de altura para seleccionar la cantidad de grupos teniendo en cuenta que a mayor cantidad más difícil puede llegar a ser la administración de dichos grupos, por lo cual se tienen en cuenta hasta cinco grupos para el análisis.

```{r}
etiqueta_grupo2 <- cutree(cluster_jerar,k=2)
kable(table(etiqueta_grupo2), col.names = c("Grupo", "Cantidad de usuarios"), align = 'c')

dendro <- as.dendrogram(cluster_jerar)
dendro.col <- dendro %>%
  set("branches_k_color", k = 2, value =   c("darkslategray2", "darkslategray3")) %>%
  set("branches_lwd", 0.6) %>%
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
ggd1 <- as.ggdend(dendro.col)
ggplot(ggd1, theme = theme_minimal()) +
  labs(x = "Número de observaciones", y = "Altura", title = "Dendrograma, k = 2")

etiqueta_grupo3 <- cutree(cluster_jerar,k=3)
kable(table(etiqueta_grupo3), col.names = c("Grupo", "Cantidad de usuarios"), align = 'c')

dendro <- as.dendrogram(cluster_jerar)
dendro.col <- dendro %>%
  set("branches_k_color", k = 3, value =   c("darkslategray2", "darkslategray3", "darkslategray4")) %>%
  set("branches_lwd", 0.6) %>%
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
ggd1 <- as.ggdend(dendro.col)
ggplot(ggd1, theme = theme_minimal()) +
  labs(x = "Número de observaciones", y = "Altura", title = "Dendrograma, k = 3")

etiqueta_grupo4 <- cutree(cluster_jerar,k=4)
kable(table(etiqueta_grupo4), col.names = c("Grupo", "Cantidad de usuarios"), align = 'c')

dendro <- as.dendrogram(cluster_jerar)
dendro.col <- dendro %>%
  set("branches_k_color", k = 4, value =   c("darkslategray2", "darkslategray3", "darkslategray4","darkslategray")) %>%
  set("branches_lwd", 0.6) %>%
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
ggd1 <- as.ggdend(dendro.col)
ggplot(ggd1, theme = theme_minimal()) +
  labs(x = "Número de observaciones", y = "Altura", title = "Dendrograma, k = 4")

etiqueta_grupo5 <- cutree(cluster_jerar,k=5)
kable(table(etiqueta_grupo5), col.names = c("Grupo", "Cantidad de usuarios"), align = 'c')

dendro <- as.dendrogram(cluster_jerar)
dendro.col <- dendro %>%
  set("branches_k_color", k = 5, value =   c("darkslategray1","darkslategray2", "darkslategray3", "darkslategray4","darkslategray")) %>%
  set("branches_lwd", 0.6) %>%
  set("labels_colors", 
      value = c("darkslategray")) %>% 
  set("labels_cex", 0.5)
ggd1 <- as.ggdend(dendro.col)
ggplot(ggd1, theme = theme_minimal()) +
  labs(x = "Número de observaciones", y = "Altura", title = "Dendrograma, k = 5")

```

De las gráficas anteriores, se observa que:
    -   Para k=2 se obtienen dos grupos desproporcionados debido a que uno de ellos queda con una cantidad de usuarios de 1828 y el otro con 405.
    -   Para k=3 se obtienen tres grupos medianamente proporcionados en los que se distribuye la cantidad de usarios en 964, 405 y 864.
    -   Para k=4 se obtienen cuatro grupos proporcionados en los que se distribuyen los usuarios en 570, 394, 405 y 864.
    -   Para k=5 se obtiene lo mismo de k=4 con la diferencia que el grupo 2 se divide en dos partes iguales volviendo un poco desequilibrados los grupos. 
  
No obstante, se complementa el análisis por medio de un diagrama de codos, como se evidencia a continuación:
```{r echo=TRUE, message=FALSE, warning=FALSE}
library(factoextra)
fviz_nbclust(datos_cluster, FUN = hcut, method = "silhouette")
```

Teniendo en cuenta el diagrama de codos, se evidencia que a partir de 4 grupos deja de ser significativo el cambio. Por dicha razón, se evidencian cuatro grupos interesantes para estudiar. 

#### Caracterización estadística de los grupos seleccionados
Para cada uno de los grupos, se realiza una tabla descriptiva teniendo en cuenta cada una de las variables de la base de datos, así:

$GRUPO~~1$
```{r}
library(DT)
descripcion <- summary(datos_cluster[etiqueta_grupo4==1,])
descripcion <- as.data.frame(descripcion)
descripcion$Var1 <- rep.int(1:6,nrow(descripcion)/6)

descripcion$Freq <- as.character(descripcion$Freq)
descripcion$Freq <- sapply(strsplit(descripcion$Freq, split=':', fixed=TRUE), function(x) (x[2]))
descripcion$Freq <- lapply(descripcion$Freq,trimws)
descripcion$Freq <- as.integer(descripcion$Freq)
descripcion$Freq <- ifelse(is.na(descripcion$Freq), '', descripcion$Freq)

grupo1 <- pivot_wider(descripcion,names_from = Var2,values_from = Freq)

#formattable(grupo1,list( grupo1[,]= color_tile("#DeF7E9", "#71CA97")))

formattable(grupo1, sapply(names(grupo1), function(row) {
  row = color_tile("#DeF7E9", "#71CA97")
})) %>%
  as.datatable(escape = FALSE,
               options = list(scrollX = TRUE,paging = FALSE,searching = FALSE, ordering = FALSE),
               rownames = FALSE)
```

$GRUPO~~2$
```{r}
descripcion <- summary(datos_cluster[etiqueta_grupo4==2,])
descripcion <- as.data.frame(descripcion)
descripcion$Var1 <- rep.int(1:6,nrow(descripcion)/6)

descripcion$Freq <- as.character(descripcion$Freq)
descripcion$Freq <- sapply(strsplit(descripcion$Freq, split=':', fixed=TRUE), function(x) (x[2]))
descripcion$Freq <- lapply(descripcion$Freq,trimws)
descripcion$Freq <- as.integer(descripcion$Freq)
descripcion$Freq <- ifelse(is.na(descripcion$Freq), '', descripcion$Freq)

grupo1 <- pivot_wider(descripcion,names_from = Var2,values_from = Freq)

#formattable(grupo1,list( grupo1[,]= color_tile("#DeF7E9", "#71CA97")))

formattable(grupo1, sapply(names(grupo1), function(row) {
  row = color_tile("#DeF7E9", "#71CA97")
})) %>%
  as.datatable(escape = FALSE,
               options = list(scrollX = TRUE,paging = FALSE,searching = FALSE, ordering = FALSE),
               rownames = FALSE)
```

$GRUPO ~~ 3$
```{r}
descripcion <- summary(datos_cluster[etiqueta_grupo4==3,])
descripcion <- as.data.frame(descripcion)
descripcion$Var1 <- rep.int(1:6,nrow(descripcion)/6)

descripcion$Freq <- as.character(descripcion$Freq)
descripcion$Freq <- sapply(strsplit(descripcion$Freq, split=':', fixed=TRUE), function(x) (x[2]))
descripcion$Freq <- lapply(descripcion$Freq,trimws)
descripcion$Freq <- as.integer(descripcion$Freq)
descripcion$Freq <- ifelse(is.na(descripcion$Freq), '', descripcion$Freq)

grupo1 <- pivot_wider(descripcion,names_from = Var2,values_from = Freq)

#formattable(grupo1,list( grupo1[,]= color_tile("#DeF7E9", "#71CA97")))

formattable(grupo1, sapply(names(grupo1), function(row) {
  row = color_tile("#DeF7E9", "#71CA97")
})) %>%
  as.datatable(escape = FALSE,
               options = list(scrollX = TRUE,paging = FALSE,searching = FALSE, ordering = FALSE),
               rownames = FALSE)
```

$GRUPO ~~ 4$
```{r}
descripcion <- summary(datos_cluster[etiqueta_grupo4==4,])
descripcion <- as.data.frame(descripcion)
descripcion$Var1 <- rep.int(1:6,nrow(descripcion)/6)

descripcion$Freq <- as.character(descripcion$Freq)
descripcion$Freq <- sapply(strsplit(descripcion$Freq, split=':', fixed=TRUE), function(x) (x[2]))
descripcion$Freq <- lapply(descripcion$Freq,trimws)
descripcion$Freq <- as.integer(descripcion$Freq)
descripcion$Freq <- ifelse(is.na(descripcion$Freq), '', descripcion$Freq)

grupo1 <- pivot_wider(descripcion,names_from = Var2,values_from = Freq)

#formattable(grupo1,list( grupo1[,]= color_tile("#DeF7E9", "#71CA97")))

formattable(grupo1, sapply(names(grupo1), function(row) {
  row = color_tile("#DeF7E9", "#71CA97")
})) %>%
  as.datatable(escape = FALSE,
               options = list(scrollX = TRUE,paging = FALSE,searching = FALSE, ordering = FALSE),
               rownames = FALSE)
```

### Descripción de resultados

GRUPO 1.
Comportamiento de los clientes.
Entradas:
-	Valor del ticket promedio en cuartil 1
-	Cantidad de transacciones mensuales promedio en cuartil 1
Salidas:
-	Valor del ticket promedio en cuartil 1 
-	Cantidad de transacciones mensuales promedio en el cuartil 1 
DESCRIPCIÓN: Podría decirse entonces que las empresas pertenecientes a este grupo son pequeñas y no muy conocidas, dado que sus movimientos o cantidad de transacciones por medio de entornos físicos y/o virtuales son pocos, ya sean de entrada o de salida; y con productos no muy costosos, pues el valor de sus transacciones tanto de entrada como de salida son muy bajos dentro del total de clientes (¿?). 
Estados financieros y características.
-	Importaciones-compras, exportaciones-ventas en categorías 1 y 2
-	Las cxp y cxc en categorías 1 y 2
-	Valor de inventarios en categoría 1
-	Ciclos de negocio y financiero en categorías 4, 5 y 6
-	Pagos personas jurídicas en categoría 3-4 y personas naturales 1-2

GRUPO 2.
Comportamiento de los clientes.
Entradas:
-	Valor del ticket promedio en cuartil 2-3-4 para todos los canales a excepción del 7,10 y otros, que se encuentra en el cuartil 1
-	Cantidad de transacciones mensuales promedio en cuartil 2-3-4 para todos los canales, a excepción del 7,10 y otros que se encuentra en el cuartil 1
Salidas:
-	Valor del ticket promedio en cuartil 1 y2
-	Cantidad de transacciones mensuales promedio en el cuartil 1 y 3
DESCRIPCIÓN: Este grupo está conformado por empresas medianas, pues posee una cantidad considerable de transacciones de entrada, con valores de transacciones medios/elevados, por lo que ofrecen productos y/o servicios de más calidad. Además, no suelen utilizar canales como el 7,10 y otros; y cuando lo hacen, el valor medio de sus transacciones se encuentra en el menor rango. Podría existir desconfianza para dichos canales (¿?).
El valor de las transacciones promedio de salida es bajo, se demoran en pagar (¿?). 
Estados financieros y características.
-	Importaciones-compras, exportaciones-ventas en categorías 1 y 2
-	Las cxp y cxc en categorías 1 y 2
-	Valor de inventarios en categoría 2-3
-	Pagos personas jurídicas en categoría 2 y personas naturales 3-4
-	Más tiendas virtuales que fisicas
-	Ciclos de negocio en categorías 4, 5 y 6 y financiero en 5 y 6
GRUPO 3.
Comportamiento de los clientes.
Entradas:
-	Valor del ticket promedio en cuartil 4 para todos los canales a excepción del 7,10 y otros, que se encuentra en el cuartil 1 y 2
-	Cantidad de transacciones mensuales promedio en cuartil 4 para todos los canales, a excepción del 7,10 y otros que se encuentra en el cuartil 1 y 2
Salidas:
-	Valor del ticket promedio en cuartil 4, 1 y 2
-	Cantidad de transacciones mensuales promedio en el cuartil 4, 1 y 2
DESCRIPCIÓN: Este grupo cuenta con empresas grandes, pues posee gran cantidad de transacciones promedio de entrada que ofrecen productos y/o servicios de alta calidad, pues poseen un valor de transacciones alto. Al igual que el grupo 2, estas empresas usan poco los canales 7,10 y otros para todo lo relacionado con las entradas, como por ejemplo recaudos y consignaciones. Podría decirse que existe desconfianza en el uso de dichos canales.
Cantidad de transacciones y valor promedio de transacción para las salidas está entre bajo (1-2) y alto (4). Se puede explicar por la gran cantidad de movimientos dado que son empresas grandes (¿?)
Estados financieros y características.
-	Importaciones-compras, exportaciones-ventas en categorías 2
-	Las cxp y cxc en categorías 6
-	Valor de inventarios en categoría 6
-	Pagos personas jurídicas en categoría 1-2 y personas naturales 3-4
-	Tiendas electronicas
-	Ciclos de negocio y financiero en categorías 4, 5 y 6
GRUPO 4.
Comportamiento de los clientes.
Entradas:
-	Valor del ticket promedio en cuartil 4 para todos los canales a excepción del 7,10 y otros, que se encuentra en el cuartil 1 y 2
-	Cantidad de transacciones mensuales promedio en cuartil 4 para todos los canales, a excepción del 7,10 y otros que se encuentra en el cuartil 1 y 2
Salidas:
-	Valor del ticket promedio en cuartil 4, 1 y 2
-	Cantidad de transacciones mensuales promedio en el cuartil 4, 1 y 2
DESCRIPCIÓN: Este grupo cuenta con empresas grandes que ofrecen productos y/o servicios de alta calidad, pues cuentan con gran cantidad de entradas para la mayoría de sus canales con valores de transacción promedio elevados. Las empresas de este grupo también poseen desconfianza en los canales 7,10 y otros para todo lo relacionado con devoluciones, recaudos, consignaciones, entre otros; dado que la cantidad de transacciones y el valor de estas es bajo. Existe desconfianza en el uso de dichos canales para transacciones de entrada importantes.
Cantidad de transacciones y valor promedio de transacción para las salidas está entre bajo (1-2) y alto (4). Se puede explicar por la gran cantidad de movimientos dado que son empresas grandes (¿¡)
Estados financieros y características.
-	Importaciones-compras, exportaciones-ventas en categorías 1-2
-	Las cxp y cxc en categorías 1-2-3
-	Valor de inventarios en categoría 1-2-3
-	Pagos personas jurídicas en categoría y personas naturales 2-3-4
-	Ciclos de negocio 4-5-6 y financiero en categorías 5-6


### Conclusiones

### Referencias
[1]. https://www.rdocumentation.org/packages/cluster/versions/2.1.2/topics/daisy
